<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Vietnamese Cultural Artifacts AR - Fixed</title>
    <!-- Load scripts in correct order -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .audio-button {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
        }

        .audio-button:active {
            transform: scale(0.9);
        }

        .audio-button.playing {
            background: rgba(76, 175, 80, 0.9);
            border-color: rgba(76, 175, 80, 0.5);
            animation: audioPlaying 2s infinite;
        }

        .audio-button.paused {
            background: rgba(255, 193, 7, 0.9);
            border-color: rgba(255, 193, 7, 0.5);
        }

        @keyframes audioPlaying {
            0% {
                box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
            }

            50% {
                box-shadow: 0 8px 32px rgba(76, 175, 80, 0.6);
            }

            100% {
                box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
            }
        }

        .status-indicator {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            right: 20px;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            display: none;
            pointer-events: none;
        }

        .status-indicator.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .model-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(20px);
            display: none;
            max-height: 200px;
            overflow-y: auto;
            pointer-events: auto;
        }

        .model-info.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }

        .model-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4CAF50;
        }

        .model-description {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .model-details {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .audio-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #4CAF50;
            margin-top: 8px;
        }

        .audio-info.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: white;
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }

        .loading-progress {
            width: 80%;
            max-width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-details {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 10px;
        }

        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 15;
            backdrop-filter: blur(20px);
            display: none;
            max-width: 90vw;
        }

        .error-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .error-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .error-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .tracking-counter {
            position: fixed;
            top: env(safe-area-inset-top, 80px);
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            display: none;
            pointer-events: none;
        }

        .debug-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 10px;
            max-width: 200px;
            display: none;
            pointer-events: none;
        }

        .debug-info.visible {
            display: block;
        }

        .fallback-mode {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 152, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 15;
            backdrop-filter: blur(20px);
            display: none;
        }

        .fallback-mode.visible {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">ƒêang kh·ªüi t·∫°o AR...</div>
        <div class="loading-subtitle" id="loadingSubtitle">Vui l√≤ng ch·ªù trong gi√¢y l√°t</div>
        <div class="loading-progress" id="loadingProgress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
        <div class="loading-details" id="loadingDetails">ƒêang t·∫£i th∆∞ vi·ªán AR...</div>
    </div>

    <!-- UI Overlay -->
    <div class="ui-overlay">
        <div class="audio-button" id="audioButton">üîä</div>

        <div class="status-indicator" id="statusIndicator">
            ƒê√£ ph√°t hi·ªán: Hi·ªán v·∫≠t
        </div>

        <div class="tracking-counter" id="trackingCounter">
            Tracking: 0/0
        </div>

        <div class="model-info" id="modelInfo">
            <div class="model-name" id="modelName">T√™n hi·ªán v·∫≠t</div>
            <div class="model-description" id="modelDescription">M√¥ t·∫£ hi·ªán v·∫≠t</div>
            <div class="model-details" id="modelDetails"></div>
            <div class="audio-info" id="audioInfo">
                <span>üéµ</span>
                <span>Nh·∫•n n√∫t audio ƒë·ªÉ nghe gi·ªõi thi·ªáu</span>
            </div>
        </div>

        <div class="error-message" id="errorMessage">
            <div class="error-icon">‚ùå</div>
            <div class="error-title">L·ªói kh·ªüi t·∫°o AR</div>
            <div class="error-subtitle">Kh√¥ng th·ªÉ kh·ªüi t·∫°o AR viewer</div>
        </div>

        <div class="fallback-mode" id="fallbackMode">
            <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <div style="font-weight: 600; margin-bottom: 5px;">Ch·∫ø ƒë·ªô d·ª± ph√≤ng</div>
            <div style="font-size: 14px;">AR kh√¥ng kh·∫£ d·ª•ng, hi·ªÉn th·ªã model 3D th√¥ng th∆∞·ªùng</div>
        </div>

        <div class="debug-info" id="debugInfo">
            <div>A-Frame: <span id="aframeStatus">Loading...</span></div>
            <div>MindAR: <span id="mindarStatus">Loading...</span></div>
            <div>Camera: <span id="cameraStatus">Checking...</span></div>
            <div>Models: <span id="modelsStatus">0/0</span></div>
        </div>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <!-- A-Frame Scene - Will be created dynamically -->
    <div id="sceneContainer"></div>

    <script>
        // Global variables
        let artifactsData = [];
        let visibleTargets = new Set();
        let currentArtifactIndex = -1;
        let isAudioPlaying = false;
        let dataReceived = false;
        let modelBlobUrls = new Map();
        let currentLoadingProgress = 0;
        let totalModelsToLoad = 0;
        let modelsLoaded = 0;
        let arInitialized = false;
        let fallbackMode = false;

        // UI Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loadingText = document.getElementById('loadingText');
        const loadingSubtitle = document.getElementById('loadingSubtitle');
        const loadingProgress = document.getElementById('loadingProgress');
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        const loadingDetails = document.getElementById('loadingDetails');
        const statusIndicator = document.getElementById('statusIndicator');
        const trackingCounter = document.getElementById('trackingCounter');
        const modelInfo = document.getElementById('modelInfo');
        const modelName = document.getElementById('modelName');
        const modelDescription = document.getElementById('modelDescription');
        const modelDetails = document.getElementById('modelDetails');
        const audioInfo = document.getElementById('audioInfo');
        const audioButton = document.getElementById('audioButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const errorMessage = document.getElementById('errorMessage');
        const fallbackModeEl = document.getElementById('fallbackMode');
        const debugInfo = document.getElementById('debugInfo');
        const aframeStatus = document.getElementById('aframeStatus');
        const mindarStatus = document.getElementById('mindarStatus');
        const cameraStatus = document.getElementById('cameraStatus');
        const modelsStatus = document.getElementById('modelsStatus');

        // Demo data
        const DEMO_ARTIFACTS = [
            {
                "tenHienVat3D": "T∆∞·ª£ng s∆∞ t·ª≠ ƒë√° ch√πa H∆∞∆°ng L√£ng",
                "gioiThieu": "T∆∞·ª£ng s∆∞ t·ª≠ ƒë√° ch√πa H∆∞∆°ng L√£ng hi·ªán ƒëang l∆∞u gi·ªØ t·∫°i Ch√πa H∆∞∆°ng L√£ng, x√£ Minh H·∫£i, huy·ªán VƒÉn L√¢m, t·ªânh H∆∞ng Y√™n, ƒë∆∞·ª£c c√¥ng nh·∫≠n l√† B·∫£o v·∫≠t qu·ªëc gia.",
                "model3dPcGlb": "https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/raccoon/scene.gltf",
                "audio": "",
                "chieuCao": "175",
                "chieuDai": "280",
                "chieuRong": "350",
                "hienVatObj": {
                    "nienDaiTuongDoi": "Cu·ªëi Th·∫ø k·ª∑ XI - ƒë·∫ßu Th·∫ø k·ª∑ XII",
                    "diaDiemLuuGiu": "Ch√πa H∆∞∆°ng L√£ng, x√£ Minh H·∫£i, huy·ªán VƒÉn L√¢m, t·ªânh H∆∞ng Y√™n"
                }
            }
        ];

        // Utility functions
        function log(message, data = null) {
            console.log(`[AR Viewer] ${message}`, data || '');
        }

        function updateLoadingProgress(progress, details = '') {
            loadingProgressBar.style.width = `${progress}%`;
            if (details) {
                loadingDetails.textContent = details;
            }
        }

        function updateDebugInfo() {
            debugInfo.classList.add('visible');
            aframeStatus.textContent = typeof AFRAME !== 'undefined' ? 'OK' : 'Error';
            mindarStatus.textContent = typeof MINDAR !== 'undefined' ? 'OK' : 'Error';
            modelsStatus.textContent = `${modelsLoaded}/${totalModelsToLoad}`;
        }

        function showError(title, subtitle, duration = 5000) {
            errorMessage.querySelector('.error-title').textContent = title;
            errorMessage.querySelector('.error-subtitle').textContent = subtitle;
            errorMessage.style.display = 'block';

            log(`ERROR: ${title} - ${subtitle}`);

            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, duration);
        }

        function extractUrls(urlString) {
            if (!urlString) return [];
            return urlString.split(',').map(url => url.trim()).filter(url => url.length > 0);
        }

        function getFirstUrl(urlString) {
            const urls = extractUrls(urlString);
            return urls.length > 0 ? urls[0] : null;
        }

        // Check if all required libraries are loaded
        function checkDependencies() {
            log('Checking dependencies...');

            if (typeof AFRAME === 'undefined') {
                log('A-Frame not loaded');
                return false;
            }

            if (typeof MINDAR === 'undefined') {
                log('MindAR not loaded');
                return false;
            }

            log('All dependencies loaded successfully');
            return true;
        }

        // Initialize AR scene safely
        function initializeARScene() {
            return new Promise((resolve, reject) => {
                try {
                    log('Initializing AR scene...');

                    const sceneContainer = document.getElementById('sceneContainer');

                    // Create A-Frame scene
                    const scene = document.createElement('a-scene');
                    scene.setAttribute('mindar-image', 'imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/targets.mind; maxTrack: 3;');
                    scene.setAttribute('color-space', 'sRGB');
                    scene.setAttribute('renderer', 'colorManagement: true; physicallyCorrectLights');
                    scene.setAttribute('vr-mode-ui', 'enabled: false');
                    scene.setAttribute('device-orientation-permission-ui', 'enabled: false');
                    scene.setAttribute('loading-screen', 'enabled: false');
                    scene.setAttribute('stats', 'false');
                    scene.id = 'ar-scene';

                    // Create assets
                    const assets = document.createElement('a-assets');
                    assets.id = 'ar-assets';

                    // Add fallback model
                    const fallbackAsset = document.createElement('a-asset-item');
                    fallbackAsset.id = 'fallbackModel';
                    fallbackAsset.src = 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/raccoon/scene.gltf';
                    assets.appendChild(fallbackAsset);

                    scene.appendChild(assets);

                    // Add lighting
                    const ambientLight = document.createElement('a-light');
                    ambientLight.setAttribute('type', 'ambient');
                    ambientLight.setAttribute('color', '#ffffff');
                    ambientLight.setAttribute('intensity', '1.0');
                    scene.appendChild(ambientLight);

                    const directionalLight = document.createElement('a-light');
                    directionalLight.setAttribute('type', 'directional');
                    directionalLight.setAttribute('position', '1 1 1');
                    directionalLight.setAttribute('color', '#ffffff');
                    directionalLight.setAttribute('intensity', '1.5');
                    scene.appendChild(directionalLight);

                    // Add camera
                    const camera = document.createElement('a-camera');
                    camera.setAttribute('position', '0 0 0');
                    camera.setAttribute('look-controls', 'enabled: false');
                    scene.appendChild(camera);

                    sceneContainer.appendChild(scene);

                    // Wait for scene to load
                    scene.addEventListener('loaded', () => {
                        log('A-Frame scene loaded successfully');
                        arInitialized = true;
                        resolve(scene);
                    });

                    scene.addEventListener('error', (error) => {
                        log('A-Frame scene error:', error);
                        reject(error);
                    });

                    // Timeout fallback
                    setTimeout(() => {
                        if (!arInitialized) {
                            log('AR initialization timeout, switching to fallback mode');
                            reject(new Error('AR initialization timeout'));
                        }
                    }, 10000);

                } catch (error) {
                    log('Error initializing AR scene:', error);
                    reject(error);
                }
            });
        }

        // Create fallback 3D viewer (without AR)
        function createFallbackViewer() {
            log('Creating fallback 3D viewer...');

            fallbackMode = true;
            fallbackModeEl.classList.add('visible');

            const sceneContainer = document.getElementById('sceneContainer');

            // Create simple A-Frame scene without MindAR
            const scene = document.createElement('a-scene');
            scene.setAttribute('background', 'color: #ECECEC');
            scene.setAttribute('vr-mode-ui', 'enabled: false');
            scene.setAttribute('loading-screen', 'enabled: false');
            scene.id = 'fallback-scene';

            // Add assets
            const assets = document.createElement('a-assets');
            assets.id = 'fallback-assets';
            scene.appendChild(assets);

            // Add lighting
            const ambientLight = document.createElement('a-light');
            ambientLight.setAttribute('type', 'ambient');
            ambientLight.setAttribute('color', '#ffffff');
            ambientLight.setAttribute('intensity', '0.6');
            scene.appendChild(ambientLight);

            const directionalLight = document.createElement('a-light');
            directionalLight.setAttribute('type', 'directional');
            directionalLight.setAttribute('position', '2 4 5');
            directionalLight.setAttribute('color', '#ffffff');
            directionalLight.setAttribute('intensity', '0.8');
            scene.appendChild(directionalLight);

            // Add camera with controls
            const camera = document.createElement('a-camera');
            camera.setAttribute('position', '0 1.6 3');
            camera.setAttribute('look-controls', 'enabled: true');
            camera.setAttribute('wasd-controls', 'enabled: true');
            scene.appendChild(camera);

            sceneContainer.appendChild(scene);

            // Load demo model
            loadFallbackModel();

            setTimeout(() => {
                fallbackModeEl.classList.remove('visible');
                loadingScreen.style.display = 'none';
            }, 3000);
        }

        function loadFallbackModel() {
            const scene = document.getElementById('fallback-scene');
            const assets = document.getElementById('fallback-assets');

            if (!scene || !assets) return;

            // Add model asset
            const modelAsset = document.createElement('a-asset-item');
            modelAsset.id = 'demoModel';
            modelAsset.src = DEMO_ARTIFACTS[0].model3dPcGlb;
            assets.appendChild(modelAsset);

            // Create model entity
            const modelEntity = document.createElement('a-entity');
            modelEntity.setAttribute('position', '0 0 0');

            const model = document.createElement('a-gltf-model');
            model.setAttribute('src', '#demoModel');
            model.setAttribute('scale', '0.5 0.5 0.5');
            model.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear');

            modelEntity.appendChild(model);
            scene.appendChild(modelEntity);

            // Show model info
            showModelInfo(0);
        }

        // Audio functions
        function initAudio(audioUrl) {
            if (!audioUrl) {
                audioInfo.classList.add('hidden');
                audioButton.style.display = 'none';
                return;
            }

            audioPlayer.src = audioUrl;
            audioButton.style.display = 'flex';
            audioInfo.classList.remove('hidden');
        }

        function playAudio() {
            if (audioPlayer && audioPlayer.src) {
                audioPlayer.play().then(() => {
                    isAudioPlaying = true;
                    audioButton.className = 'audio-button playing';
                    audioButton.textContent = '‚è∏Ô∏è';
                    audioInfo.classList.add('hidden');
                }).catch(error => {
                    log('Audio play error:', error);
                    showError('L·ªói Audio', 'Kh√¥ng th·ªÉ ph√°t audio');
                });
            }
        }

        function pauseAudio() {
            if (audioPlayer) {
                audioPlayer.pause();
                isAudioPlaying = false;
                audioButton.className = 'audio-button paused';
                audioButton.textContent = '‚ñ∂Ô∏è';
            }
        }

        function stopAudio() {
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isAudioPlaying = false;
                audioButton.className = 'audio-button';
                audioButton.textContent = 'üîä';
                audioInfo.classList.remove('hidden');
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Model info functions
        function showModelInfo(index) {
            const data = artifactsData[index];
            if (!data) return;

            currentArtifactIndex = index;

            modelName.textContent = data.tenHienVat3D || 'Hi·ªán v·∫≠t vƒÉn h√≥a';

            const description = data.gioiThieu || data.hienVatObj?.mieuTa || 'Kh√¥ng c√≥ m√¥ t·∫£';
            const truncatedDesc = description.length > 200 ? description.substring(0, 200) + '...' : description;
            modelDescription.textContent = truncatedDesc;

            const details = [];
            if (data.hienVatObj?.nienDaiTuongDoi) {
                details.push(`üìÖ ${data.hienVatObj.nienDaiTuongDoi}`);
            }
            if (data.chieuCao && data.chieuDai && data.chieuRong) {
                details.push(`üìè ${data.chieuCao} √ó ${data.chieuDai} √ó ${data.chieuRong} cm`);
            } else if (data.chieuCao) {
                details.push(`üìè Cao: ${data.chieuCao} cm`);
            }
            if (data.hienVatObj?.diaDiemLuuGiu) {
                details.push(`üìç ${data.hienVatObj.diaDiemLuuGiu}`);
            }
            modelDetails.innerHTML = details.join('<br>');

            modelInfo.classList.add('visible');
            statusIndicator.textContent = `Hi·ªÉn th·ªã: ${data.tenHienVat3D}`;
            statusIndicator.classList.add('visible');

            const audioUrl = getFirstUrl(data.audio);
            initAudio(audioUrl);
        }

        function hideModelInfo() {
            modelInfo.classList.remove('visible');
            statusIndicator.classList.remove('visible');
            audioButton.style.display = 'none';
            stopAudio();
            currentArtifactIndex = -1;
        }

        // Event listeners
        audioButton.addEventListener('click', () => {
            if (isAudioPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        });

        // Message handling from React Native
        window.addEventListener("message", function (event) {
            try {
                log("Received message from React Native");

                let data;
                if (typeof event.data === 'string') {
                    data = JSON.parse(event.data);
                } else {
                    data = event.data;
                }

                if (Array.isArray(data) && data.length > 0) {
                    dataReceived = true;
                    artifactsData = data;
                    log(`Received ${artifactsData.length} artifacts`);

                    // Update display if in fallback mode
                    if (fallbackMode) {
                        showModelInfo(0);
                    }

                } else if (data && (data.tenHienVat3D || data.hienVatObj)) {
                    dataReceived = true;
                    artifactsData = [data];
                    log("Received single artifact:", data.tenHienVat3D);

                    if (fallbackMode) {
                        showModelInfo(0);
                    }
                }
            } catch (error) {
                log("Error processing message:", error);
                showError("L·ªói d·ªØ li·ªáu", "Kh√¥ng th·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ ·ª©ng d·ª•ng");
            }
        });

        // Send ready message to React Native
        function sendReadyMessage() {
            try {
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'ready',
                        message: 'AR viewer is ready',
                        mode: fallbackMode ? 'fallback' : 'ar'
                    }));
                }
            } catch (error) {
                log("ReactNativeWebView not available");
            }
        }

        // Initialize everything
        async function initialize() {
            try {
                log('Starting initialization...');
                updateLoadingProgress(10, 'Ki·ªÉm tra th∆∞ vi·ªán...');
                updateDebugInfo();

                // Wait a bit for all scripts to load
                await new Promise(resolve => setTimeout(resolve, 1000));

                updateLoadingProgress(30, 'Ki·ªÉm tra dependencies...');

                if (!checkDependencies()) {
                    throw new Error('Required libraries not loaded');
                }

                updateLoadingProgress(50, 'Kh·ªüi t·∫°o AR...');

                // Try to initialize AR
                try {
                    await initializeARScene();
                    updateLoadingProgress(80, 'AR ƒë√£ s·∫µn s√†ng');
                    log('AR initialization successful');
                } catch (arError) {
                    log('AR initialization failed, switching to fallback mode:', arError);
                    updateLoadingProgress(60, 'Chuy·ªÉn sang ch·∫ø ƒë·ªô d·ª± ph√≤ng...');
                    createFallbackViewer();
                    return;
                }

                updateLoadingProgress(90, 'T·∫£i d·ªØ li·ªáu demo...');

                // Load demo data
                artifactsData = DEMO_ARTIFACTS;

                updateLoadingProgress(100, 'Ho√†n t·∫•t!');

                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    sendReadyMessage();
                }, 1000);

            } catch (error) {
                log('Initialization failed:', error);
                showError('L·ªói kh·ªüi t·∫°o', 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o AR viewer');

                // Try fallback mode as last resort
                setTimeout(() => {
                    createFallbackViewer();
                }, 2000);
            }
        }

        // Start initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM loaded, starting initialization...');
            initialize();
        });

        // Also try when window loads
        window.addEventListener('load', () => {
            log('Window loaded');
            if (!arInitialized && !fallbackMode) {
                initialize();
            }
        });
    </script>
</body>

</html>